#!/bin/bash
set -e

SERVICE_NAME="{{ service_name }}"
SERVICE_ID="{{ service_name }}"
SERVICE_PORT={{ service_port }}

CONSUL_HOST="{{ consul_host }}"
CONSUL_PORT={{ consul_port }}

SERVICE_ADDRESS="{{ ansible_facts['default_ipv4']['address'] }}"

TAGS='{{ service_tags | default(["microservice"]) | to_json }}'
META='{{ service_meta | default({}) | to_json }}'

# Check HTTP calculado 100% en Jinja (sin mezclar Bash)
{% if service_name == 'rabbitmq' %}
CHECK_HTTP="https://{{ ansible_facts['default_ipv4']['address'] }}:15672/api/healthchecks/node"
{% else %}
CHECK_HTTP="https://{{ ansible_facts['default_ipv4']['address'] }}:{{ service_port }}/docs"
{% endif %}

curl --fail --silent --show-error \
  --cacert /home/ubuntu/app/certs/ca.pem \
  -k \
  -X PUT "https://${CONSUL_HOST}:${CONSUL_PORT}/v1/agent/service/register" \
  -H "Content-Type: application/json" \
  -d "{
    \"ID\": \"${SERVICE_ID}\",
    \"Name\": \"${SERVICE_NAME}\",
    \"Address\": \"${SERVICE_ADDRESS}\",
    \"Port\": ${SERVICE_PORT},
    \"Tags\": ${TAGS},
    \"Meta\": ${META},
    \"Check\": {
      \"HTTP\": \"${CHECK_HTTP}\",
      \"Interval\": \"10s\",
      \"Timeout\": \"5s\"
    }
  }"

echo "âœ” Servicio ${SERVICE_NAME} registrado en Consul (${SERVICE_ADDRESS}:${SERVICE_PORT})"